# NATS Container App (3 replicas for clustering)
apiVersion: apps/v1
kind: ContainerApp
metadata:
  name: bindplane-nats
  namespace: default
spec:
  environmentId: test-env-12345
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: false
      targetPort: 4222
  template:
    containers:
      - name: nats
        image: ghcr.io/observiq/bindplane-ee:1.94.0
        command:
          - /bin/sh
          - -c
          - |
            # Start NATS server with clustering configuration
            nats-server \
              --server_name=$POD_NAME \
              --host=0.0.0.0 \
              --port=4222 \
              --http_port=8222 \
              --cluster_name=bindplane-nats-cluster \
              --cluster_port=6222 \
              --cluster_routes=nats://bindplane-nats-0:6222,nats://bindplane-nats-1:6222,nats://bindplane-nats-2:6222 \
              --jetstream \
              --store_dir=/data
        resources:
          cpu: 1000m
          memory: 1024Mi
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: BINDPLANE_MODE
            value: node
          - name: BINDPLANE_ANALYTICS_DISABLED
            value: "false"
          - name: BINDPLANE_TRANSFORM_AGENT_ENABLE_REMOTE
            value: "true"
          - name: BINDPLANE_TRANSFORM_AGENT_REMOTE_AGENTS
            value: "bindplane-transform-agent:4568"
          - name: BINDPLANE_LICENSE
            valueFrom:
              secretKeyRef:
                name: bindplane-license
                key: license
          - name: BINDPLANE_ACCEPT_EULA
            value: "true"
          - name: BINDPLANE_AGENT_VERSIONS_CLIENTS
            value: "github"
          - name: BINDPLANE_REMOTE_URL
            value: http://bindplane.local:80
          - name: BINDPLANE_WEB_URL
            value: http://bindplane.local:80
          - name: BINDPLANE_USERNAME
            value: bpuser
          - name: BINDPLANE_PASSWORD
            value: bppass
          - name: BINDPLANE_SESSION_SECRET
            value: 4484766F-5016-4077-B8E0-0DE1D637854B
          - name: BINDPLANE_LOGGING_OUTPUT
            value: stdout
          - name: BINDPLANE_CONFIG_HOME
            value: /data
          - name: BINDPLANE_STORE_TYPE
            value: bbolt
          - name: BINDPLANE_EVENT_BUS_TYPE
            value: nats
          - name: BINDPLANE_NATS_SERVER_ENABLE
            value: "true"
          - name: BINDPLANE_NATS_SERVER_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: BINDPLANE_NATS_SERVER_CLIENT_HOST
            value: "0.0.0.0"
          - name: BINDPLANE_NATS_SERVER_CLIENT_PORT
            value: "4222"
          - name: BINDPLANE_NATS_SERVER_HTTP_HOST
            value: "0.0.0.0"
          - name: BINDPLANE_NATS_SERVER_HTTP_PORT
            value: "8222"
          - name: BINDPLANE_NATS_SERVER_CLUSTER_NAME
            value: bindplane-nats-cluster
          - name: BINDPLANE_NATS_SERVER_CLUSTER_HOST
            value: "0.0.0.0"
          - name: BINDPLANE_NATS_SERVER_CLUSTER_PORT
            value: "6222"
          - name: BINDPLANE_NATS_CLIENT_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: BINDPLANE_NATS_CLIENT_ENDPOINT
            value: nats://127.0.0.1:4222
          - name: BINDPLANE_NATS_CLIENT_SUBJECT
            value: bindplane-event-bus
          - name: BINDPLANE_PORT
            value: "3001"
          - name: BINDPLANE_PROMETHEUS_ENABLE
            value: "true"
          - name: BINDPLANE_PROMETHEUS_ENABLE_REMOTE
            value: "true"
          - name: BINDPLANE_PROMETHEUS_HOST
            value: bindplane-prometheus
          - name: BINDPLANE_PROMETHEUS_PORT
            value: "9090"
          - name: BINDPLANE_PROMETHEUS_REMOTE_WRITE_ENDPOINT
            value: /api/v1/write
          - name: BINDPLANE_PROMETHEUS_AUTH_TYPE
            value: none
          - name: BINDPLANE_METRICS_TYPE
            value: prometheus
          - name: BINDPLANE_METRICS_PROMETHEUS_ENDPOINT
            value: /metrics
          - name: BINDPLANE_LOGGING_LEVEL
            value: debug
        ports:
          - containerPort: 4222
            name: tcp
          - containerPort: 6222
            name: nats-cluster
          - containerPort: 8222
            name: nats-http
        volumeMounts:
          - name: data
            mountPath: /data
        livenessProbe:
          httpGet:
            path: /healthz?js-enabled-only=true
            port: 8222
          initialDelaySeconds: 0
          periodSeconds: 30
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /healthz?js-server-only=true
            port: 8222
          initialDelaySeconds: 0
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
    volumes:
      - name: data
        storageType: AzureFile
        storageName: nats-data-pv
    scale:
      minReplicas: 3
      maxReplicas: 3
