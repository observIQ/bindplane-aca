name: bindplane
type: Microsoft.App/containerApps
location: eastus
identity:
  type: UserAssigned
  userAssignedIdentities:
    {{.ManagedIdentityID}}: {}
properties:
  managedEnvironmentId: {{.ACAEnvironmentID}}
  configuration:
    activeRevisionsMode: Single
    ingress:
      external: true
      targetPort: 3001
      allowInsecure: true
  template:
    containers:
      - name: server
        #image: ghcr.io/observiq/bindplane-ee:{{.BindplaneTag}}
        image: observiq/bindplane-ee-amd64:1.97.0-SNAPSHOT-e0838d114
        resources:
          cpu: 2.0
          memory: 4Gi
        env:
          - name: BINDPLANE_MODE
            value: node

          - name: BINDPLANE_POSTGRES_MAX_CONNECTIONS
            value: "50" # Default is 100
          - name: BINDPLANE_POSTGRES_MAX_IDLE_CONNECTIONS
            value: "15" # Default is 50
          - name: BINDPLANE_MAX_CONCURRENCY
            value: "15" # Default is 10
          - name: BINDPLANE_AGENTS_MAX_SIMULTANEOUS_CONNECTIONS
            value: "15" # Default is 10



          - name: BINDPLANE_ANALYTICS_DISABLED
            value: "false"
          - name: BINDPLANE_TRANSFORM_AGENT_ENABLE_REMOTE
            value: "true"
          - name: BINDPLANE_TRANSFORM_AGENT_REMOTE_AGENTS
            value: "bindplane-transform-agent:80"
          - name: BINDPLANE_LICENSE
            value: {{.License}}
          - name: BINDPLANE_ACCEPT_EULA
            value: "true"
          - name: BINDPLANE_AGENT_VERSIONS_CLIENTS
            value: "github"
          - name: BINDPLANE_REMOTE_URL
            value: {{.BindplaneRemoteURL}}
          - name: BINDPLANE_USERNAME
            value: bpuser
          - name: BINDPLANE_PASSWORD
            value: medora5234
          - name: BINDPLANE_SESSION_SECRET
            value: {{.SessionSecret}}
          - name: BINDPLANE_LOGGING_OUTPUT
            value: stdout,otlp
          - name: BINDPLANE_LOGGING_OTLP_ENDPOINT
            value: "otelcol:4317"
          - name: BINDPLANE_LOGGING_OTLP_INSECURE
            value: "true"
          - name: BINDPLANE_LOGGING_OTLP_INTERVAL
            value: "5s"
          - name: BINDPLANE_CONFIG_HOME
            value: /data
          - name: BINDPLANE_STORE_TYPE
            value: postgres
          - name: BINDPLANE_POSTGRES_HOST
            value: {{.PostgresHost}}
          - name: BINDPLANE_POSTGRES_PORT
            value: "5432"
          - name: BINDPLANE_POSTGRES_USERNAME
            value: {{.PostgresUsername}}
          - name: BINDPLANE_POSTGRES_PASSWORD
            value: "{{.PostgresPassword}}"
          - name: BINDPLANE_POSTGRES_DATABASE
            value: {{.PostgresDatabase}}
          - name: BINDPLANE_POSTGRES_SSL_MODE
            value: {{.PostgresSSLMode}}
          - name: BINDPLANE_EVENT_BUS_TYPE
            value: azure
          - name: BINDPLANE_AZURE_CONNECTION_STRING
            value: {{.AzureConnectionString}}
          - name: BINDPLANE_AZURE_TOPIC
            value: {{.AzureTopic}}
          - name: BINDPLANE_AZURE_SUBSCRIPTION_ID
            value: {{.AzureSubscriptionID}}
          - name: BINDPLANE_AZURE_RESOURCE_GROUP
            value: {{.AzureResourceGroup}}
          - name: BINDPLANE_AZURE_NAMESPACE
            value: {{.AzureNamespace}}
          - name: AZURE_CLIENT_ID
            value: {{.AzureClientID}}
          - name: BINDPLANE_AZURE_MAX_BATCH_SIZE
            value: 1000
          - name: BINDPLANE_AZURE_MAX_PAYLOAD_SIZE
            value: 10000000
          - name: BINDPLANE_PORT
            value: "3001"
          - name: BINDPLANE_PROMETHEUS_ENABLE
            value: "true"
          - name: BINDPLANE_PROMETHEUS_ENABLE_REMOTE
            value: "true"
          - name: BINDPLANE_PROMETHEUS_HOST
            value: 10.0.0.5
          - name: BINDPLANE_PROMETHEUS_PORT
            value: "9090"
          - name: BINDPLANE_PROMETHEUS_REMOTE_WRITE_ENDPOINT
            value: /api/v1/write
          - name: BINDPLANE_PROMETHEUS_AUTH_TYPE
            value: none
          - name: BINDPLANE_METRICS_TYPE
            value: otlp
          - name: BINDPLANE_METRICS_OTLP_ENDPOINT
            value: "otelcol:4317"
          - name: BINDPLANE_METRICS_OTLP_INSECURE
            value: "true"
          - name: BINDPLANE_LOGGING_LEVEL
            value: debug
          - name: BINDPLANE_EVENT_BUS_HEALTH_REQUIRED_ACKS
            value: "2"
          - name: BINDPLANE_EVENT_BUS_HEALTH_MAX_ACKS
            value: "6"
          - name: BINDPLANE_TRACING_TYPE
            value: otlp
          - name: BINDPLANE_TRACING_OTLP_ENDPOINT
            value: "otelcol:4317"
          - name: BINDPLANE_TRACING_OTLP_INSECURE
            value: "true"
          - name: BINDPLANE_TRACING_SAMPLING_RATE
            value: "1.0"
        probes:
          - type: liveness
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 0
            periodSeconds: 30
            timeoutSeconds: 1
            failureThreshold: 3
          - type: readiness
            httpGet:
              path: /health
              port: 3001
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 3
    scale:
      minReplicas: 8
      maxReplicas: 8
